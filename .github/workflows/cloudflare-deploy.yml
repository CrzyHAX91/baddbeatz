name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-build:
    name: Test Build Process
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'baddbeatz/package-lock.json'

    - name: Install dependencies
      run: |
        cd baddbeatz
        npm ci

    - name: Verify Wrangler configuration
      run: |
        cd baddbeatz
        echo "ðŸ” Checking Wrangler configuration..."
        npx wrangler --version
        
        # Validate wrangler.toml syntax
        if npx wrangler dev --dry-run --local; then
          echo "âœ… Wrangler configuration is valid"
        else
          echo "âŒ Wrangler configuration has issues"
          exit 1
        fi

    - name: Build assets
      run: |
        cd baddbeatz
        echo "ðŸš€ Building assets for Cloudflare deployment..."
        npm run build:assets
        
        # Verify build output
        echo "ðŸ“¦ Verifying build output..."
        if [ -d "dist" ]; then
          echo "âœ… dist directory created"
          echo "ðŸ“„ Files in dist:"
          ls -la dist/
          
          # Count files
          FILE_COUNT=$(find dist -type f | wc -l)
          echo "ðŸ“Š Total files: $FILE_COUNT"
          
          if [ $FILE_COUNT -lt 25 ]; then
            echo "âš ï¸  Warning: Expected at least 25 files, got $FILE_COUNT"
          else
            echo "âœ… File count looks good"
          fi
        else
          echo "âŒ dist directory not found"
          exit 1
        fi

    - name: Test critical files
      run: |
        cd baddbeatz
        echo "ðŸ§ª Testing for critical files..."
        
        CRITICAL_FILES=(
          "dist/index.html"
          "dist/dashboard.html"
          "dist/admin.html"
          "dist/manifest.json"
          "dist/service-worker.js"
          "dist/assets"
        )
        
        for file in "${CRITICAL_FILES[@]}"; do
          if [ -e "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cloudflare-build-${{ github.sha }}
        path: baddbeatz/dist/
        retention-days: 7

  deploy-preview:
    name: Deploy Preview (PR)
    runs-on: ubuntu-latest
    needs: test-build
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'baddbeatz/package-lock.json'

    - name: Install dependencies
      run: |
        cd baddbeatz
        npm ci

    - name: Build for deployment
      run: |
        cd baddbeatz
        npm run build:assets

    - name: Deploy to Cloudflare Workers (Development)
      run: |
        cd baddbeatz
        echo "ðŸš€ Deploying to Cloudflare Workers (Development Environment)..."
        npx wrangler deploy --env development
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    - name: Comment PR with preview URL
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ **Preview Deployment Complete!**\n\n' +
                  '**Development URL:** https://baddbeatz-dev.your-subdomain.workers.dev\n\n' +
                  '**Build Status:** âœ… Success\n' +
                  '**Commit:** ' + context.sha.substring(0, 7) + '\n\n' +
                  '_This preview will be available until the next deployment._'
          })

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: test-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://baddbeatz.nl
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'baddbeatz/package-lock.json'

    - name: Install dependencies
      run: |
        cd baddbeatz
        npm ci

    - name: Build for production
      run: |
        cd baddbeatz
        npm run build:assets
        
        # Verify production build
        echo "ðŸ” Verifying production build..."
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Missing index.html in production build"
          exit 1
        fi
        
        if [ ! -f "dist/CNAME" ]; then
          echo "âŒ Missing CNAME file for custom domain"
          exit 1
        fi
        
        echo "âœ… Production build verified"

    - name: Deploy to Cloudflare Workers (Production)
      run: |
        cd baddbeatz
        echo "ðŸš€ Deploying to Cloudflare Workers (Production)..."
        npx wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    - name: Verify deployment
      run: |
        echo "ðŸ§ª Verifying deployment..."
        
        # Wait a moment for deployment to propagate
        sleep 10
        
        # Test main domain
        if curl -f -s https://baddbeatz.nl > /dev/null; then
          echo "âœ… Main domain (baddbeatz.nl) is responding"
        else
          echo "âš ï¸  Main domain check failed (may take time to propagate)"
        fi
        
        # Test www subdomain
        if curl -f -s https://www.baddbeatz.nl > /dev/null; then
          echo "âœ… WWW subdomain is responding"
        else
          echo "âš ï¸  WWW subdomain check failed (may take time to propagate)"
        fi

    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "**Domain:** https://baddbeatz.nl" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Deployed" >> $GITHUB_STEP_SUMMARY
        cd baddbeatz
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find dist -type f | head -20 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Old Deployments
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Cleanup artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const oldArtifacts = artifacts.data.artifacts
            .filter(artifact => artifact.name.startsWith('cloudflare-build-'))
            .filter(artifact => {
              const age = Date.now() - new Date(artifact.created_at).getTime();
              return age > 7 * 24 * 60 * 60 * 1000; // 7 days
            });
          
          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
            console.log(`Deleted artifact: ${artifact.name}`);
          }
